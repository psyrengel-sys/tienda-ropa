<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tienda de Ropa</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1222; --card:#171a2f; --accent:#6c7bff; --text:#e7e9ff; --muted:#9aa0c6; --danger:#ff6c6c; --border:#262a46; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:#0f1222;color:var(--text)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(8px);background:rgba(23,26,47,.7);border-bottom:1px solid var(--border)}
    .nav{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;gap:14px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .tools{display:flex;gap:10px;flex-wrap:wrap}
    .input,.select{background:var(--card);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none;min-width:180px}
    .badge{background:#2a2f55;color:#c8ceff;border:1px solid var(--border);padding:6px 10px;border-radius:10px;font-weight:700}
    .layout{max-width:1100px;margin:24px auto;padding:0 20px;display:grid;grid-template-columns:1fr 340px;gap:20px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .img{aspect-ratio:4/3;object-fit:cover;width:100%}
    .content{padding:14px;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:800}.muted{color:var(--muted)}.price{font-weight:800;color:#bfc6ff}
    .options{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
    .pill.active{border-color:var(--accent);background:rgba(108,123,255,.2)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#0e1224;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-outline{background:transparent;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .cart{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;position:sticky;top:86px}
    .cart-header{padding:14px;border-bottom:1px solid var(--border);font-weight:800;display:flex;justify-content:space-between}
    .cart-items{max-height:460px;overflow:auto}
    .cart-item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;padding:10px 14px;border-bottom:1px dashed var(--border)}
    .thumb{width:64px;height:64px;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
    .remove{color:var(--danger);cursor:pointer;font-weight:700}
    .cart-footer{padding:14px;display:flex;flex-direction:column;gap:10px}
    .total-line{display:flex;justify-content:space-between;font-weight:800}
    .checkout{background:linear-gradient(135deg,#6c7bff,#41d675);border:none;border-radius:12px;padding:12px 14px;color:#0e1224;font-weight:900;cursor:pointer}
    .empty{color:var(--muted);padding:14px}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">Tienda Ropa Pro</div>
      <div class="tools">
        <input id="search" class="input" type="search" placeholder="Buscar producto..." />
        <select id="category" class="select">
          <option value="all">Todas</option>
          <option value="camisetas">Camisetas</option>
          <option value="pantalones">Pantalones</option>
          <option value="sudaderas">Sudaderas</option>
          <option value="zapatillas">Zapatillas</option>
        </select>
        <span id="cartBadge" class="badge">Carrito: 0</span>
      </div>
    </div>
  </header>

  <main class="layout">
    <section><div id="grid" class="grid"></div></section>

    <aside class="cart">
      <div class="cart-header"><span>Tu carrito</span><span id="cartCount">0 artículos</span></div>
      <div id="cartItems" class="cart-items"></div>
      <div class="cart-footer">
        <div class="total-line"><span>Total</span><span id="cartTotal">0,00 €</span></div>
        <button id="checkout" class="checkout">Finalizar compra</button>
      </div>
    </aside>
  </main>

  <script>
    const API_URL = "http://localhost:3000"; // Cambia a tu dominio al desplegar

    const fmtEUR = new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" });

    let state = { search:"", category:"all", cart:loadCart(), selections:{} };

    function loadCart(){ try{ return JSON.parse(localStorage.getItem("cart"))||[] }catch{ return [] } }
    function saveCart(){ localStorage.setItem("cart", JSON.stringify(state.cart)); }

    async function fetchProducts(){
      const res = await fetch(API_URL + "/products");
      return res.json();
    }

    function filteredProducts(list){
      return list.filter(p=>{
        const okCat = state.category==="all" ? true : p.category===state.category;
        const okSearch = state.search.trim()==="" ? true : p.name.toLowerCase().includes(state.search.toLowerCase());
        return okCat && okSearch;
      });
    }

    const grid = document.getElementById("grid");
    async function renderProducts(){
      grid.innerHTML = `<div class="empty">Cargando productos...</div>`;
      const all = await fetchProducts();
      const items = filteredProducts(all);
      if(items.length===0){ grid.innerHTML = `<div class="empty">No hay productos que coincidan.</div>`; return; }
      grid.innerHTML = "";
      for(const p of items){
        const card = document.createElement("div");
        card.className = "card";
        const sizes = p.sizes || ["S","M","L","XL"];
        const colors = p.colors || ["Negro","Blanco","Azul"];
        const sel = state.selections[p.id] || { size:sizes[0], color:colors[0] };
        card.innerHTML = `
          <img class="img" src="${p.image}" alt="${p.name}">
          <div class="content">
            <div class="title">${p.name}</div>
            <div class="muted">Categoría: ${capitalize(p.category)}</div>
            <div class="price">${fmtEUR.format(p.price)}</div>
            <div class="muted">Talla</div>
            <div class="options">${sizes.map(s=>`<span class="pill ${sel.size===s?'active':''}" data-size="${p.id}:${s}">${s}</span>`).join("")}</div>
            <div class="muted">Color</div>
            <div class="options">${colors.map(c=>`<span class="pill ${sel.color===c?'active':''}" data-color="${p.id}:${c}">${c}</span>`).join("")}</div>
            <div class="actions">
              <button class="btn" data-add="${p.id}">Agregar al carrito</button>
              <button class="btn-outline" data-details="${p.id}">Detalles</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
        state.selections[p.id] = sel;
      }
    }

    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1) }

    // Carrito
    const cartItems = document.getElementById("cartItems");
    const cartTotal = document.getElementById("cartTotal");
    const cartCount = document.getElementById("cartCount");
    const cartBadge = document.getElementById("cartBadge");

    function addToCart(id){
      const sel = state.selections[id] || {};
      const itemKey = (x)=>`${x.id}-${sel.size}-${sel.color}`;
      const existing = state.cart.find(i=>itemKey(i)===`${id}-${sel.size}-${sel.color}`);
      if(existing){ existing.qty += 1; }
      else{
        const prodEl = document.querySelector(`[data-add="${id}"]`).closest(".card");
        const name = prodEl.querySelector(".title").textContent;
        const price = parseFloat(prodEl.querySelector(".price").textContent.replace(/[^\d,.-]/g,"").replace(".","").replace(",","."));
        const image = prodEl.querySelector(".img").src;
        state.cart.push({ id, name, price, image, size:sel.size, color:sel.color, qty:1 });
      }
      saveCart(); renderCart();
    }

    function removeFromCart(key){
      state.cart = state.cart.filter(i=>`${i.id}-${i.size}-${i.color}`!==key);
      saveCart(); renderCart();
    }

    function setQty(key, delta){
      const item = state.cart.find(i=>`${i.id}-${i.size}-${i.color}`===key);
      if(!item) return; item.qty = Math.max(1, item.qty+delta);
      saveCart(); renderCart();
    }

    function renderCart(){
      cartItems.innerHTML = "";
      if(state.cart.length===0){ cartItems.innerHTML = `<div class="empty">Tu carrito está vacío.</div>`; }
      else{
        for(const i of state.cart){
          const key = `${i.id}-${i.size}-${i.color}`;
          const row = document.createElement("div");
          row.className = "cart-item";
          row.innerHTML = `
            <div class="thumb"><img src="${i.image}" alt=""></div>
            <div>
              <div style="font-weight:800">${i.name}</div>
              <div class="muted">${fmtEUR.format(i.price)} — ${i.size} — ${i.color}</div>
              <div class="qty">
                <button data-dec="${key}">−</button><span>${i.qty}</span><button data-inc="${key}">+</button>
                <span class="remove" data-remove="${key}">Eliminar</span>
              </div>
            </div>
            <div style="font-weight:800">${fmtEUR.format(i.price*i.qty)}</div>
          `;
          cartItems.appendChild(row);
        }
      }
      const total = state.cart.reduce((acc,i)=>acc + i.price*i.qty, 0);
      const count = state.cart.reduce((acc,i)=>acc + i.qty, 0);
      cartTotal.textContent = fmtEUR.format(total);
      cartCount.textContent = `${count} ${count===1?'artículo':'artículos'}`;
      cartBadge.textContent = `Carrito: ${count}`;
    }

    // Eventos
    document.getElementById("search").addEventListener("input", e=>{ state.search=e.target.value; renderProducts(); });
    document.getElementById("category").addEventListener("change", e=>{ state.category=e.target.value; renderProducts(); });
    document.getElementById("checkout").addEventListener("click", ()=>{
      if(state.cart.length===0){ alert("Tu carrito está vacío."); return; }
      const total = state.cart.reduce((acc,i)=>acc + i.price*i.qty, 0);
      alert(`Gracias por tu compra.\nTotal: ${fmtEUR.format(total)}\n(Demo, sin pago real)`);
      state.cart = []; saveCart(); renderCart();
    });

    document.addEventListener("click", e=>{
      const add = e.target.closest("[data-add]");
      if(add){ addToCart(Number(add.getAttribute("data-add"))); }
      const details = e.target.closest("[data-details]");
      if(details){ alert("Detalles de ejemplo. Aquí iría una ficha completa del producto."); }
      const size = e.target.closest("[data-size]");
      if(size){
        const [pid,val] = size.getAttribute("data-size").split(":");
        state.selections[Number(pid)] = { ...(state.selections[Number(pid)]||{}), size:val };
        renderProducts();
      }
      const color = e.target.closest("[data-color]");
      if(color){
        const [pid,val] = color.getAttribute("data-color").split(":");
        state.selections[Number(pid)] = { ...(state.selections[Number(pid)]||{}), color:val };
        renderProducts();
      }
      const dec = e.target.closest("[data-dec]");
      if(dec){ setQty(dec.getAttribute("data-dec"), -1); }
      const inc = e.target.closest("[data-inc]");
      if(inc){ setQty(inc.getAttribute("data-inc"), +1); }
      const rem = e.target.closest("[data-remove]");
      if(rem){ removeFromCart(rem.getAttribute("data-remove")); }
    });

    renderProducts(); renderCart();
  </script>
</body>
</html>
